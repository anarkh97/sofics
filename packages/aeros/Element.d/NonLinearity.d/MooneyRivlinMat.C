#include <cmath>
#include <limits>
#include <Element.d/NonLinearity.d/MooneyRivlinMat.h>
#include <Element.d/NonLinearity.d/StrainEvaluator.h>
#include <Utils.d/NodeSpaceArray.h>

//Find the inverse of a 3*3 symmetric matrix and return its determinant
static double sym_matlib_inverse(double *A, double *Ainv)
{
  double det = A[0]*(A[3]*A[5]-A[4]*A[4])
              -A[1]*(A[1]*A[5]-A[4]*A[2])
              +A[2]*(A[1]*A[4]-A[3]*A[2]);

  if (fabs(det) < std::numeric_limits<double>::epsilon()) return 0.e0;

  double detinv = 1./det;
  Ainv[0] = detinv*( A[3]*A[5]-A[4]*A[4]);
  Ainv[1] = detinv*(-A[1]*A[5]+A[2]*A[4]);
  Ainv[2] = detinv*( A[1]*A[4]-A[2]*A[3]);
  Ainv[3] = detinv*( A[0]*A[5]-A[2]*A[2]);
  Ainv[4] = detinv*(-A[0]*A[4]+A[2]*A[1]);
  Ainv[5] = detinv*( A[0]*A[3]-A[1]*A[1]);
  
  return det;
}

//Constructor
MooneyRivlinMat::MooneyRivlinMat(double _rho, double _mu1, double _mu2, double _kappa)
{
  rho = _rho;
  mu1 = _mu1;
  mu2 = _mu2;
  kappa = _kappa;

//-------------------------------
c00 = 0.2684e9; //pa = kg/(m s^2) = g/(mm s^2)
c01 = 0.1098e9; //pa = kg/(m s^2) = g/(mm s^2)
c10 = 0.1098e9; //pa = kg/(m s^2) = g/(mm s^2)

M = 4.4;
//-------------------------------
}

//Copy?
NLMaterial *
MooneyRivlinMat::clone() const
{
  return new MooneyRivlinMat(*this);
}


void
MooneyRivlinMat::getStress(Tensor *_stress, Tensor &_strain, double*, double)
{
  Tensor_d0s2_Ss12 &strain = static_cast<Tensor_d0s2_Ss12 &>(_strain);

  using std::sqrt;
  using std::pow;
  // compute right Cauchy-Green tensor C = F^t*F = 2*E+I
  double C[6] = { 1+2*strain[0],  2*strain[1],   2*strain[2],
                                1+2*strain[3],   2*strain[4],
                                               1+2*strain[5] };

  // compute PK2 stresses
  double Cinv[6];
  double detC = sym_matlib_inverse(C,Cinv);

  if(detC < std::numeric_limits<double>::epsilon()) {
    std::cerr << "MooneyRivlinMat::getStress: close to negative jacobian\n";
    return;
  }

  if(_stress) {
    Tensor_d0s2_Ss12 &stress = static_cast<Tensor_d0s2_Ss12 &>(*_stress);

    stress[0] = (pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + 
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) + 
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (3*pow(C[2],2)*C[3] - 6*C[1]*C[2]*C[4] - C[3]*pow(C[4],2) + 3*pow(C[1],2)*C[5] + 
             pow(C[3],2)*C[5] - pow(C[4],2)*C[5] + C[3]*pow(C[5],2) + 
             2*C[0]*(pow(C[4],2) - C[3]*C[5])) + 
          c01*(-6*C[1]*C[2]*C[4]*(C[3] + C[5]) + 
             pow(C[2],2)*(3*pow(C[3],2) + 2*pow(C[4],2) + C[3]*C[5]) + 
             pow(C[1],2)*(2*pow(C[4],2) + C[5]*(C[3] + 3*C[5])) + 
             (pow(C[4],2) - C[3]*C[5])*(C[0]*(C[3] + C[5]) + 2*(pow(C[4],2) - C[3]*C[5])))) + 
       3*(-pow(C[4],2) + C[3]*C[5])*(-1 + 
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] + 
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) + 
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) + 
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - 
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.; 
 
    stress[1] = (2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*(C[0] + C[3] + C[5])*(C[2]*C[4] - C[1]*C[5])*
           pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
          c01*(4*pow(C[1],2)*C[2]*C[4] - pow(C[1],3)*C[5] +
             2*C[2]*C[4]*(-pow(C[2],2) - pow(C[4],2) + C[3]*C[5] + C[0]*(C[3] + C[5])) +
             C[1]*(-3*C[0]*pow(C[4],2) + C[0]*(C[3] - 2*C[5])*C[5] +
                pow(C[2],2)*(-3*C[3] + 2*C[5]) + 2*C[5]*(pow(C[4],2) - C[3]*C[5])))) -
       3*(-(C[2]*C[4]) + C[1]*C[5])*(-1 +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;

    stress[2] =  (2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*(C[2]*C[3] - C[1]*C[4])*(C[0] + C[3] + C[5])*
           pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
          c01*(2*pow(C[1],3)*C[4] + pow(C[1],2)*C[2]*(-2*C[3] + 3*C[5]) -
             2*C[1]*C[4]*(2*pow(C[2],2) - pow(C[4],2) + C[3]*C[5] + C[0]*(C[3] + C[5])) +
             C[2]*(pow(C[2],2)*C[3] + C[0]*(2*pow(C[3],2) + 3*pow(C[4],2) - C[3]*C[5]) +
                2*C[3]*(-pow(C[4],2) + C[3]*C[5])))) -
       3*(C[2]*C[3] - C[1]*C[4])*(-1 + pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
            C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;

    stress[3] = (pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (-6*C[1]*C[2]*C[4] + pow(C[2],2)*(2*C[3] - C[5]) + pow(C[0],2)*C[5] +
             3*pow(C[1],2)*C[5] + C[0]*
              (-pow(C[2],2) + 3*pow(C[4],2) - 2*C[3]*C[5] + pow(C[5],2))) +
          c01*(2*pow(C[2],4) - 6*C[1]*C[2]*C[4]*(C[0] + C[5]) +
             pow(C[2],2)*(2*pow(C[4],2) + C[0]*(C[3] - 4*C[5]) + C[3]*C[5]) +
             pow(C[1],2)*(2*pow(C[2],2) + C[5]*(C[0] + 3*C[5])) +
             C[0]*(3*C[0]*pow(C[4],2) + C[0]*C[5]*(-C[3] + 2*C[5]) + C[5]*(pow(C[4],2) - C[3]*C[5]))
             )) + 3*(-pow(C[2],2) + C[0]*C[5])*
        (-1 + pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;
 
    stress[4] = (2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*(C[1]*C[2] - C[0]*C[4])*(C[0] + C[3] + C[5])*
           pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
          c01*(-2*pow(C[1],3)*C[2] + pow(C[1],2)*C[4]*(2*C[0] - 3*C[5]) +
             2*C[1]*C[2]*(-pow(C[2],2) + 2*pow(C[4],2) + C[3]*C[5] + C[0]*(C[3] + C[5])) -
             C[4]*(3*pow(C[2],2)*C[3] + 2*pow(C[0],2)*(C[3] + C[5]) +
                C[0]*(-2*pow(C[2],2) + pow(C[4],2) - C[3]*C[5])))) -
       3*(-(C[1]*C[2]) + C[0]*C[4])*(-1 +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;
 
    stress[5] = (pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (pow(C[0],2)*C[3] + 3*pow(C[2],2)*C[3] - 6*C[1]*C[2]*C[4] -
             pow(C[1],2)*(C[3] - 2*C[5]) +
             C[0]*(-pow(C[1],2) + pow(C[3],2) + 3*pow(C[4],2) - 2*C[3]*C[5])) +
          c01*(2*pow(C[1],4) + 3*pow(C[2],2)*pow(C[3],2) - 6*C[1]*C[2]*(C[0] + C[3])*C[4] +
             C[0]*C[3]*(pow(C[2],2) + pow(C[4],2) - C[3]*C[5]) +
             pow(C[0],2)*(2*pow(C[3],2) + 3*pow(C[4],2) - C[3]*C[5]) +
             pow(C[1],2)*(2*pow(C[2],2) - 4*C[0]*C[3] + 2*pow(C[4],2) + C[0]*C[5] + C[3]*C[5])
             )) + 3*(-pow(C[1],2) + C[0]*C[3])*
        (-1 + pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;

  }
//  std::cout << "MooneyRivlinMat::getStress: function finished running" << std::endl;
}

void 
MooneyRivlinMat::getTangentMaterial(Tensor *_tm, Tensor &_strain, double*, double)
{
  std::cerr << "MooneyRivlinMat::getTangentMaterial is not implemented\n"; exit(-1);
}

void 
MooneyRivlinMat::getStressAndTangentMaterial(Tensor *_stress, Tensor *_tm, Tensor &_strain, double*, double)
{
  std::cerr << "MooneyRivlinMat::getStressAndTangentMaterial is not implemented\n"; exit(-1);
}


void 
MooneyRivlinMat::integrate(Tensor *_stress, Tensor *_tm, Tensor &, Tensor &_strain,
                           double *, double *, double, Tensor *, double) const
{
/*
  std::cerr << "MooneyRivlinMat::integrate(9-paramater version) is not implemented\n"; exit(-1);
*/
//  std::cout << "Using the integrate function with 'tm'..." << std::endl;
  Tensor_d0s2_Ss12 &strain = static_cast<Tensor_d0s2_Ss12 &>(_strain);

  using std::sqrt;
  using std::pow;
  // compute right Cauchy-Green tensor C = F^t*F = 2*E+I
  double C[6] = { 1+2*strain[0],  2*strain[1],   2*strain[2],
                                1+2*strain[3],   2*strain[4],
                                               1+2*strain[5] };

  // compute PK2 stresses and derivatives wrt E
  double Cinv[6];
  double detC = sym_matlib_inverse(C,Cinv);

  if(detC < std::numeric_limits<double>::epsilon()) {
    std::cerr << "MooneyRivlinMat::integrate: close to negative jacobian\n";
    return;
  }

  if(_stress) {
    Tensor_d0s2_Ss12 &stress = static_cast<Tensor_d0s2_Ss12 &>(*_stress);

    stress[0] = (pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + 
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) + 
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (3*pow(C[2],2)*C[3] - 6*C[1]*C[2]*C[4] - C[3]*pow(C[4],2) + 3*pow(C[1],2)*C[5] + 
             pow(C[3],2)*C[5] - pow(C[4],2)*C[5] + C[3]*pow(C[5],2) + 
             2*C[0]*(pow(C[4],2) - C[3]*C[5])) + 
          c01*(-6*C[1]*C[2]*C[4]*(C[3] + C[5]) + 
             pow(C[2],2)*(3*pow(C[3],2) + 2*pow(C[4],2) + C[3]*C[5]) + 
             pow(C[1],2)*(2*pow(C[4],2) + C[5]*(C[3] + 3*C[5])) + 
             (pow(C[4],2) - C[3]*C[5])*(C[0]*(C[3] + C[5]) + 2*(pow(C[4],2) - C[3]*C[5])))) + 
       3*(-pow(C[4],2) + C[3]*C[5])*(-1 + 
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] + 
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) + 
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) + 
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - 
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.; 
 
    stress[1] = (2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*(C[0] + C[3] + C[5])*(C[2]*C[4] - C[1]*C[5])*
           pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
          c01*(4*pow(C[1],2)*C[2]*C[4] - pow(C[1],3)*C[5] +
             2*C[2]*C[4]*(-pow(C[2],2) - pow(C[4],2) + C[3]*C[5] + C[0]*(C[3] + C[5])) +
             C[1]*(-3*C[0]*pow(C[4],2) + C[0]*(C[3] - 2*C[5])*C[5] +
                pow(C[2],2)*(-3*C[3] + 2*C[5]) + 2*C[5]*(pow(C[4],2) - C[3]*C[5])))) -
       3*(-(C[2]*C[4]) + C[1]*C[5])*(-1 +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;

    stress[2] =  (2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*(C[2]*C[3] - C[1]*C[4])*(C[0] + C[3] + C[5])*
           pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
          c01*(2*pow(C[1],3)*C[4] + pow(C[1],2)*C[2]*(-2*C[3] + 3*C[5]) -
             2*C[1]*C[4]*(2*pow(C[2],2) - pow(C[4],2) + C[3]*C[5] + C[0]*(C[3] + C[5])) +
             C[2]*(pow(C[2],2)*C[3] + C[0]*(2*pow(C[3],2) + 3*pow(C[4],2) - C[3]*C[5]) +
                2*C[3]*(-pow(C[4],2) + C[3]*C[5])))) -
       3*(C[2]*C[3] - C[1]*C[4])*(-1 + pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
            C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;

    stress[3] = (pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (-6*C[1]*C[2]*C[4] + pow(C[2],2)*(2*C[3] - C[5]) + pow(C[0],2)*C[5] +
             3*pow(C[1],2)*C[5] + C[0]*
              (-pow(C[2],2) + 3*pow(C[4],2) - 2*C[3]*C[5] + pow(C[5],2))) +
          c01*(2*pow(C[2],4) - 6*C[1]*C[2]*C[4]*(C[0] + C[5]) +
             pow(C[2],2)*(2*pow(C[4],2) + C[0]*(C[3] - 4*C[5]) + C[3]*C[5]) +
             pow(C[1],2)*(2*pow(C[2],2) + C[5]*(C[0] + 3*C[5])) +
             C[0]*(3*C[0]*pow(C[4],2) + C[0]*C[5]*(-C[3] + 2*C[5]) + C[5]*(pow(C[4],2) - C[3]*C[5]))
             )) + 3*(-pow(C[2],2) + C[0]*C[5])*
        (-1 + pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;
 
    stress[4] = (2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*(C[1]*C[2] - C[0]*C[4])*(C[0] + C[3] + C[5])*
           pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
          c01*(-2*pow(C[1],3)*C[2] + pow(C[1],2)*C[4]*(2*C[0] - 3*C[5]) +
             2*C[1]*C[2]*(-pow(C[2],2) + 2*pow(C[4],2) + C[3]*C[5] + C[0]*(C[3] + C[5])) -
             C[4]*(3*pow(C[2],2)*C[3] + 2*pow(C[0],2)*(C[3] + C[5]) +
                C[0]*(-2*pow(C[2],2) + pow(C[4],2) - C[3]*C[5])))) -
       3*(-(C[1]*C[2]) + C[0]*C[4])*(-1 +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;
 
    stress[5] = (pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (pow(C[0],2)*C[3] + 3*pow(C[2],2)*C[3] - 6*C[1]*C[2]*C[4] -
             pow(C[1],2)*(C[3] - 2*C[5]) +
             C[0]*(-pow(C[1],2) + pow(C[3],2) + 3*pow(C[4],2) - 2*C[3]*C[5])) +
          c01*(2*pow(C[1],4) + 3*pow(C[2],2)*pow(C[3],2) - 6*C[1]*C[2]*(C[0] + C[3])*C[4] +
             C[0]*C[3]*(pow(C[2],2) + pow(C[4],2) - C[3]*C[5]) +
             pow(C[0],2)*(2*pow(C[3],2) + 3*pow(C[4],2) - C[3]*C[5]) +
             pow(C[1],2)*(2*pow(C[2],2) - 4*C[0]*C[3] + 2*pow(C[4],2) + C[0]*C[5] + C[3]*C[5])
             )) + 3*(-pow(C[1],2) + C[0]*C[3])*
        (-1 + pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;


  }

  if(_tm) {
    Tensor_d0s4_Ss12s34 &tm = static_cast<Tensor_d0s4_Ss12s34 &>(*_tm);

//------------temporarily set tm to 0-----------------------------------   
    tm[0][0] = 0;
    tm[0][1] = tm[1][0] = 0;
    tm[0][2] = tm[2][0] = 0;
    tm[0][3] = tm[3][0] = 0;
    tm[0][4] = tm[4][0] = 0;
    tm[0][5] = tm[5][0] = 0;

    tm[1][1] = 0;
    tm[1][2] = 0;
    tm[1][3] = tm[3][1] = 0;
    tm[1][4] = tm[4][1] = 0;
    tm[1][5] = tm[5][1] = 0;

    tm[2][2] = 0;
    tm[2][3] = tm[3][2] = 0;
    tm[2][4] = tm[4][2] = 0;
    tm[2][5] = tm[5][2] = 0;

    tm[3][3] = 0;
    tm[3][4] = tm[4][3] = 0;
    tm[3][5] = tm[5][3] = 0;

    tm[4][4] = 0;
    tm[4][5] = 0;

    tm[5][5] = 0;
//--------------end temporarily set tm to 0-----------------------------


/*
    double lambda = 4*kappa*sqrt(detC)*(sqrt(detC)-0.5);

    double Cinv2[21] = { Cinv[0]*Cinv[0], Cinv[0]*Cinv[1], Cinv[0]*Cinv[2], Cinv[0]*Cinv[3], Cinv[0]*Cinv[4], Cinv[0]*Cinv[5],
                                          Cinv[1]*Cinv[1], Cinv[1]*Cinv[2], Cinv[1]*Cinv[3], Cinv[1]*Cinv[4], Cinv[1]*Cinv[5],
                                                           Cinv[2]*Cinv[2], Cinv[2]*Cinv[3], Cinv[2]*Cinv[4], Cinv[2]*Cinv[5],
                                                                            Cinv[3]*Cinv[3], Cinv[3]*Cinv[4], Cinv[3]*Cinv[5],
                                                                                             Cinv[4]*Cinv[4], Cinv[4]*Cinv[5],
                                                                                                              Cinv[5]*Cinv[5]};

    double lamin1 = lambda-coef;
    double lamin2 = lambda-2*coef;
    double twoc = 2*coef;
    tm[0][0] = lamin2*Cinv2[0];
    tm[0][1] = tm[1][0] = lamin2*Cinv2[1];
    tm[0][2] = tm[2][0] = lamin2*Cinv2[2];
    tm[0][3] = tm[3][0] = lambda*Cinv2[3] - twoc*Cinv2[6] + 4*mu2;
    tm[0][4] = tm[4][0] = lambda*Cinv2[4] - twoc*Cinv2[7];
    tm[0][5] = tm[5][0] = lambda*Cinv2[5] - twoc*Cinv2[11] + 4*mu2;

    tm[1][1] = lamin1*Cinv2[6] - coef*Cinv2[3] - 2*mu2;
    tm[1][2] = tm[2][1] = lamin1*Cinv2[7] - coef*Cinv2[4];
    tm[1][3] = tm[3][1] = lamin2*Cinv2[8];
    tm[1][4] = tm[4][1] = lamin1*Cinv2[9] - coef*Cinv2[12];
    tm[1][5] = tm[5][1] = lambda*Cinv2[10] - twoc*Cinv2[13];

    tm[2][2] = lamin1*Cinv2[11] - coef*Cinv2[5 ] - 2*mu2;
    tm[2][3] = tm[3][2] = lambda*Cinv2[12] - twoc*Cinv2[9];
    tm[2][4] = tm[4][2] = lamin1*Cinv2[13] - coef*Cinv2[10];
    tm[2][5] = tm[5][2] = lamin2*Cinv2[14];

    tm[3][3] = lamin2*Cinv2[15];
    tm[3][4] = tm[4][3] = lamin2*Cinv2[16];
    tm[3][5] = tm[5][3] = lambda*Cinv2[17] - twoc*Cinv2[18] + 4*mu2;

    tm[4][4] = lamin1*Cinv2[18] - coef*Cinv2[17] - 2*mu2;
    tm[4][5] = tm[5][4] = lamin2*Cinv2[19];

    tm[5][5] = lamin2*Cinv2[20];

*/
  }

}


void
MooneyRivlinMat::integrate(Tensor *_stress, Tensor &, Tensor &_strain,
                           double *, double *, double, Tensor *, double) const
{
//  std::cout << "MooneyRivlinMat: Using the integrate function without 'tm'..." << std::endl;

  Tensor_d0s2_Ss12 &strain = static_cast<Tensor_d0s2_Ss12 &>(_strain);

  using std::sqrt;
  using std::pow;
  // compute right Cauchy-Green tensor C = F^t*F = 2*E+I
  double C[6] = { 1+2*strain[0],  2*strain[1],   2*strain[2],
                                1+2*strain[3],   2*strain[4],
                                               1+2*strain[5] };

  // compute PK2 stresses
  double Cinv[6];
  double detC = sym_matlib_inverse(C,Cinv);

  if(detC < std::numeric_limits<double>::epsilon()) {
    std::cerr << "MooneyRivlinMat::integrate: close to negative jacobian\n";
    return;
  }

  if(_stress) {
    Tensor_d0s2_Ss12 &stress = static_cast<Tensor_d0s2_Ss12 &>(*_stress);

    stress[0] = (pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + 
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) + 
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (3*pow(C[2],2)*C[3] - 6*C[1]*C[2]*C[4] - C[3]*pow(C[4],2) + 3*pow(C[1],2)*C[5] + 
             pow(C[3],2)*C[5] - pow(C[4],2)*C[5] + C[3]*pow(C[5],2) + 
             2*C[0]*(pow(C[4],2) - C[3]*C[5])) + 
          c01*(-6*C[1]*C[2]*C[4]*(C[3] + C[5]) + 
             pow(C[2],2)*(3*pow(C[3],2) + 2*pow(C[4],2) + C[3]*C[5]) + 
             pow(C[1],2)*(2*pow(C[4],2) + C[5]*(C[3] + 3*C[5])) + 
             (pow(C[4],2) - C[3]*C[5])*(C[0]*(C[3] + C[5]) + 2*(pow(C[4],2) - C[3]*C[5])))) + 
       3*(-pow(C[4],2) + C[3]*C[5])*(-1 + 
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] + 
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) + 
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - 
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) + 
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - 
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.; 
 
    stress[1] = (2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*(C[0] + C[3] + C[5])*(C[2]*C[4] - C[1]*C[5])*
           pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
          c01*(4*pow(C[1],2)*C[2]*C[4] - pow(C[1],3)*C[5] +
             2*C[2]*C[4]*(-pow(C[2],2) - pow(C[4],2) + C[3]*C[5] + C[0]*(C[3] + C[5])) +
             C[1]*(-3*C[0]*pow(C[4],2) + C[0]*(C[3] - 2*C[5])*C[5] +
                pow(C[2],2)*(-3*C[3] + 2*C[5]) + 2*C[5]*(pow(C[4],2) - C[3]*C[5])))) -
       3*(-(C[2]*C[4]) + C[1]*C[5])*(-1 +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;

    stress[2] =  (2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*(C[2]*C[3] - C[1]*C[4])*(C[0] + C[3] + C[5])*
           pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
          c01*(2*pow(C[1],3)*C[4] + pow(C[1],2)*C[2]*(-2*C[3] + 3*C[5]) -
             2*C[1]*C[4]*(2*pow(C[2],2) - pow(C[4],2) + C[3]*C[5] + C[0]*(C[3] + C[5])) +
             C[2]*(pow(C[2],2)*C[3] + C[0]*(2*pow(C[3],2) + 3*pow(C[4],2) - C[3]*C[5]) +
                2*C[3]*(-pow(C[4],2) + C[3]*C[5])))) -
       3*(C[2]*C[3] - C[1]*C[4])*(-1 + pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
            C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;

    stress[3] = (pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (-6*C[1]*C[2]*C[4] + pow(C[2],2)*(2*C[3] - C[5]) + pow(C[0],2)*C[5] +
             3*pow(C[1],2)*C[5] + C[0]*
              (-pow(C[2],2) + 3*pow(C[4],2) - 2*C[3]*C[5] + pow(C[5],2))) +
          c01*(2*pow(C[2],4) - 6*C[1]*C[2]*C[4]*(C[0] + C[5]) +
             pow(C[2],2)*(2*pow(C[4],2) + C[0]*(C[3] - 4*C[5]) + C[3]*C[5]) +
             pow(C[1],2)*(2*pow(C[2],2) + C[5]*(C[0] + 3*C[5])) +
             C[0]*(3*C[0]*pow(C[4],2) + C[0]*C[5]*(-C[3] + 2*C[5]) + C[5]*(pow(C[4],2) - C[3]*C[5]))
             )) + 3*(-pow(C[2],2) + C[0]*C[5])*
        (-1 + pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;
 
    stress[4] = (2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*(C[1]*C[2] - C[0]*C[4])*(C[0] + C[3] + C[5])*
           pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
          c01*(-2*pow(C[1],3)*C[2] + pow(C[1],2)*C[4]*(2*C[0] - 3*C[5]) +
             2*C[1]*C[2]*(-pow(C[2],2) + 2*pow(C[4],2) + C[3]*C[5] + C[0]*(C[3] + C[5])) -
             C[4]*(3*pow(C[2],2)*C[3] + 2*pow(C[0],2)*(C[3] + C[5]) +
                C[0]*(-2*pow(C[2],2) + pow(C[4],2) - C[3]*C[5])))) -
       3*(-(C[1]*C[2]) + C[0]*C[4])*(-1 +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;
 
    stress[5] = (pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) - pow(C[1],2)*C[5] +
       C[0]*C[3]*C[5],-1.6666666666666667 - M/2.)*
     (-2*(1 - 2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.) +
          2*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/2.))*
        (c10*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (pow(C[0],2)*C[3] + 3*pow(C[2],2)*C[3] - 6*C[1]*C[2]*C[4] -
             pow(C[1],2)*(C[3] - 2*C[5]) +
             C[0]*(-pow(C[1],2) + pow(C[3],2) + 3*pow(C[4],2) - 2*C[3]*C[5])) +
          c01*(2*pow(C[1],4) + 3*pow(C[2],2)*pow(C[3],2) - 6*C[1]*C[2]*(C[0] + C[3])*C[4] +
             C[0]*C[3]*(pow(C[2],2) + pow(C[4],2) - C[3]*C[5]) +
             pow(C[0],2)*(2*pow(C[3],2) + 3*pow(C[4],2) - C[3]*C[5]) +
             pow(C[1],2)*(2*pow(C[2],2) - 4*C[0]*C[3] + 2*pow(C[4],2) + C[0]*C[5] + C[3]*C[5])
             )) + 3*(-pow(C[1],2) + C[0]*C[3])*
        (-1 + pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
            pow(C[1],2)*C[5] + C[0]*C[3]*C[5],M/4.))*
        (-(c01*(pow(C[1],2) + pow(C[2],2) - C[0]*C[3] + pow(C[4],2) - C[0]*C[5] - C[3]*C[5] +
               3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                  pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.6666666666666666))) +
          pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
             pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333)*
           (C[0]*c10 + c00*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] - C[0]*pow(C[4],2) -
                pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333) +
             c10*(C[3] + C[5] - 3*pow(-(pow(C[2],2)*C[3]) + 2*C[1]*C[2]*C[4] -
                   C[0]*pow(C[4],2) - pow(C[1],2)*C[5] + C[0]*C[3]*C[5],0.3333333333333333))
             ))*M))/3.;

  }
}

double
MooneyRivlinMat::getStrainEnergyDensity(Tensor &_strain, double *, double)
{
//  std::cout << "MooneyRivlinMat::getStrainEnergyDensity: function invoked" << std::endl;
  Tensor_d0s2_Ss12 &strain = static_cast<Tensor_d0s2_Ss12 &>(_strain);

  using std::log;
  double C[6] = { 1+2*strain[0],  2*strain[1],   2*strain[2],
                                1+2*strain[3],   2*strain[4],
                                               1+2*strain[5] };

  double detC = C[0]*(C[3]*C[5]-C[4]*C[4])-C[1]*(C[1]*C[5]-C[4]*C[2])+C[2]*(C[1]*C[4]-C[3]*C[2]);
  if(detC < std::numeric_limits<double>::epsilon()) {
    std::cerr << "MooneyRivlinMat::integrate: close to negative jacobian\n";
    return 0;
  }

  double I1 = C[0]+C[3]+C[5];
  double I2 = 0.5*(I1*I1-(C[0]*C[0]+C[3]*C[3]+C[5]*C[5]+2*(C[1]*C[1]+C[2]*C[2]+C[4]*C[4])));
  double J = sqrt(detC);
  double I1Bar = pow(J, -2/3)*I1;  
  double I2Bar = pow(J, -4/3)*I2;
  return (pow(J,-M) - 2*pow(J,-M/2) +2)*(c00 + c01*(I2Bar-3) + c10*(I1Bar-3));
}

void
MooneyRivlinMat::getMaterialConstants(std::vector<double> &c)
{
  c.resize(3);
  c[0] = mu1;
  c[1] = mu2;
  c[2] = kappa;
//  std::cout << "MooneyRivlinMat::getMaterialConstants: function finished" << std::endl;
}

extern GreenLagrangeStrain greenLagrangeStrain;

StrainEvaluator *
MooneyRivlinMat::getStrainEvaluator() const
{
//  std::cout << "MooneyRivlinMat::getStrainEvaluator: function invoked" << std::endl;
  return &greenLagrangeStrain;
}

void
MooneyRivlinMat::print(std::ostream &out) const
{
  out << "MooneyRivlinClifton " << rho << " " << mu1 << " " << mu2 << " " << kappa << " " << c00 << " " << c01 << " " << c10 << " " << M;
}
